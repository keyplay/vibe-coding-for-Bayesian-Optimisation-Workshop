# Bioprocess Optimisation 开发日志

## 项目概述

使用多保真度贝叶斯优化 (Multi-Fidelity Bayesian Optimization) 解决生物过程优化问题，在 15000 预算内最大化 titre（产量）。

---

## 指令 #1: 介绍 Notebook

**用户指令**: `@C_Bioprocess_Optimisation_Collab.ipynb 介绍这个`

**当时状态**: 初始状态，尚未开始任何开发

**执行结果**: 分析了 notebook 结构，介绍了：
- 三个保真度等级：fid=0 (3L Batch, 成本10)、fid=1 (3L ContBatch, 成本575)、fid=2 (15L ContBatch, 成本2100)
- 5个设计变量：Temperature, pH, F1, F2, F3
- 15000 总预算约束
- 提出基础方案和进阶方案（多保真度 BO）两种实现路线

---

## 指令 #2: 使用进阶方案完成任务

**用户指令**: `使用进阶方案完成任务`

**当时状态**: 已了解任务需求

**执行结果**: 在 Cell 7 实现了基于 sklearn GP 的多保真度 BO 方案：
- Phase 0: Sobol 序列初始化 7 个低保真度点
- Phase 1: 低保真度探索（UCB 采集函数）
- Phase 2: 中保真度精炼（EI 采集函数）
- Phase 3: 高保真度确认
- 初始版本中初始 7 个点**未计入预算**

---

## 指令 #3: 初始点计入预算

**用户指令**: `初始的7个点也要计入budget`

**当时问题**: 初始的 7 个 Sobol 采样点没有扣除预算，导致实际花费超出 15000

**修复**: 将 Phase 0 的 `_evaluate` 调用从 `count_cost=False` 改为 `count_cost=True`

---

## 指令 #4: 是否可以用 BOTorch 实现

**用户指令**: `是否可以用botorch实现`

**当时状态**: sklearn 方案已完成，希望探索更专业的框架

**执行结果**: 提出两个方案供选择：
- 方案 A: 纯 BOTorch（使用 `KnowledgeGradient` 多保真度采集函数）
- 方案 B: BOTorch 混合方案（`SingleTaskMultiFidelityGP` + 保留分阶段预算策略）

**用户选择**: 方案 B

---

## 指令 #5: 在新 Cell 实现方案 B

**用户指令**: `在另外的cell实现方案b`

**当时状态**: 确定使用 BOTorch 混合方案

**执行结果**: 在 Cell 9 和 Cell 10 新增 BOTorch 实现，包括：
- `fit_mf_gp()`: 拟合 `SingleTaskMultiFidelityGP`，保真度映射 {0,1,2} → {0.0, 0.5, 1.0}
- `BO_BOTorch` 类：使用 `qUpperConfidenceBound`（探索）和 `qLogNoisyExpectedImprovement`（精炼）
- `FixedFeatureAcquisitionFunction` 固定保真度维度优化

**遇到的问题**:
1. `ModuleNotFoundError: No module named 'Experiment_simulations'` → 修正 import 路径
2. `ValueError: The truth value of an array...` → Phase 3 参考点选择时数组比较问题，改用显式 `None` 检查

---

## 指令 #6: 实现计划（Plan Mode 生成的详细方案）

**用户指令**: `Implement the plan as specified`

**当时状态**: 根据 Plan Mode 生成的详细实现规范进行编码

**执行结果**: 完善了 BOTorch 方案的所有细节

---

## 指令 #7: 如何确定每阶段实验数量

**用户指令**: `如何确定每个阶段实验的数量`

**当时状态**: BOTorch 方案已实现，想理解预算分配逻辑

**执行结果**: 解释了预算驱动的动态分配策略：
- Phase 1: 花费约 2000（~200 次低保真度实验）
- Phase 2: 花费到 `budget - n_hf_reserve × 2100`（~18 次中保真度实验）
- Phase 3: 剩余预算（2-3 次高保真度实验）
- 每阶段实验数量不是预设的，而是由预算消耗动态决定

---

## 指令 #8: 备份为独立 .py 文件，注释改英文

**用户指令**: `将新方案备份到一个独立的.py文件中，并将注释修改为英文`

**当时状态**: BOTorch 方案代码稳定

**执行结果**: 创建 `C_Bioprocess_botorch_Yubo.py`，所有中文注释翻译为英文

---

## 指令 #9: 确认低保真度给料变量数量

**用户指令**: `低保真度实验的给料变量是不是只有1个，而中保真和高保真有3个`

**当时状态**: 对不同保真度的变量维度有疑问

**分析结果**: 确认了关键差异：
- **fid=0**: `feeding = [(40, 0), (60, F2), (120, 0)]` → 只有 F2 有效（t=60 投料）
- **fid=1/2**: `feeding = [(40, F1), (80, F2), (120, F3)]` → 三个 feed 都有效

---

## 指令 #10: 确认最新方案是否考虑了这点

**用户指令**: `最新的解决方案是否考虑了这一点`

**当时问题**: 种子从 fid=0 迁移到 fid=1 时，直接复制了 F1 和 F3 的值，但这些值在 fid=0 中实际被忽略（被设为 0），是随机初始化时的无意义值

**结论**: 未考虑，需要修复

---

## 指令 #11: 种子迁移时对 F1/F3 做随机化

**用户指令**: `好的，修改目前的方案，种子迁移时，对 F1/F3 做随机化或拉丁超立方采样`

**当时问题**: fid=0 中 F1/F3 无意义，直接迁移会误导中保真度搜索

**修复**: 种子迁移时保留 T 和 pH，对 F1/F3 做全范围 [0, 50] 随机化

---

## 指令 #12: 理论最优条件是什么值

**用户指令**: `理论的最优条件的效果是什么值？通过阅读代码理论分析即可`

**当时状态**: 想了解理论上限

**分析结果**: 通过代码分析 + 数值网格搜索（fid=2, noise≈0）：
- **理论最优 titre ≈ 197.6**
- 最优参数：T=32°C, pH=7.2, F1=30, F2=0, F3=44
- 关键发现：最优 F2=0，说明 t=80 时不投料反而更好

---

## 指令 #13: 低保真度给料时间与中保真度一样吗

**用户指令**: `低保真度的给料时间是和中保真度的时间一样嘛`

**当时状态**: 进一步了解投料时间差异

**分析结果**:
- fid=0 投料时间：F2 在 **t=60**
- fid=1/2 投料时间：F1 在 **t=40**, F2 在 **t=80**, F3 在 **t=120**
- 时间点不同：fid=0 的 t=60 夹在 fid=1 的 t=40 和 t=80 之间

---

## 指令 #14: 利用 t=60 与 t=40/t=80 的接近性

**用户指令**: `但60与40 和80都很接近，能否利用这点`

**当时问题**: 全范围随机化可能浪费了 fid=0 中 F2 的信息

**修复（v1）**: 种子迁移策略改为：
- F1: 以 fid=0 的 F2 为中心 ±15 扰动（t=60 ≈ t=40）
- F2/F3: 全范围 [0, 50] 随机

**测试结果**: sklearn 版得分从 73.88 降至 68.28，说明 F2 全随机可能不够好

---

## 指令 #15: F1 F2 都参考 Low-fidelity

**用户指令**: `改回F1 F2都参考Low-fidelity`

**当时问题**: 上一版只有 F1 参考 fid0-F2，F2 全随机

**修复（v2）**: 种子迁移策略改为：
- F1: 以 fid=0 的 F2 为中心 ±15 扰动
- F2: 以 fid=0 的 F2 为中心 ±15 扰动
- F3: 全范围 [0, 50] 随机

---

## 指令 #16: 查看用户手动修改，同步到 notebook

**用户指令**: `查看我改的代码，更新刚刚的ipynb文件`

**当时问题**: 用户手动修改了 `.py` 文件中的扰动范围和策略

**用户修改内容**:
- F1: ±15 → **±5**
- F2: ±15 → **±5**
- F3: 全随机 → **以 fid0-F2 为中心 ±10**

**执行结果**: 将用户修改同步到 notebook Cell 7 和 Cell 9

---

## 指令 #17: T 和 pH 是否完全照搬

**用户指令**: `中高保真度的T和ph是完全照搬低保真的结果吗`

**当时状态**: 确认种子迁移中 T/pH 的处理方式

**分析结果**: 确认 T 和 pH 是完全复制的，未做任何扰动。由于所有保真度共享相同的动力学参数，这是合理的，但可以加小扰动增加多样性。

---

## 指令 #18: 给 T 和 pH 加小扰动

**用户指令**: `迁移时给T和ph加一点小扰动`

**当时问题**: T/pH 完全照搬，缺乏多样性

**修复**: 种子迁移策略最终版：

| 变量 | 参考值 | 扰动范围 | 约束 |
|------|--------|----------|------|
| T | fid0 最优值 | ±1°C | [30, 40] |
| pH | fid0 最优值 | ±0.1 | [6, 8] |
| F1 | fid0 的 F2 | ±5 | [0, 50] |
| F2 | fid0 的 F2 | ±5 | [0, 50] |
| F3 | fid0 的 F2 | ±10 | [0, 50] |

---

## 版本演化总结

### 种子迁移策略变化

```
v0 (初始)     : T/pH/F1/F2/F3 全部直接复制 → fid=0 中 F1/F3 无意义
v1 (指令#11)  : T/pH 复制, F1/F3 全范围随机
v2 (指令#14)  : T/pH 复制, F1 参考 fid0-F2 ±15, F2/F3 全随机
v3 (指令#15)  : T/pH 复制, F1/F2 参考 fid0-F2 ±15, F3 全随机
v4 (指令#16)  : T/pH 复制, F1/F2 参考 fid0-F2 ±5, F3 参考 fid0-F2 ±10
v5 (指令#18)  : T ±1°C, pH ±0.1, F1/F2 参考 fid0-F2 ±5, F3 参考 fid0-F2 ±10 ← 当前版本
```

### 关键文件

| 文件 | 内容 |
|------|------|
| `C_Bioprocess_Optimisation_Collab.ipynb` Cell 7 | sklearn GP 多保真度 BO |
| `C_Bioprocess_Optimisation_Collab.ipynb` Cell 9 | BOTorch `SingleTaskMultiFidelityGP` 混合方案 |
| `C_Bioprocess_Optimisation_Collab.ipynb` Cell 10 | BOTorch 方案执行入口 |
| `C_Bioprocess_botorch_Yubo.py` | BOTorch 方案独立备份（英文注释） |

### 关键发现

1. **保真度变量差异**: fid=0 只用 F2 (t=60)，fid=1/2 用 F1(t=40)/F2(t=80)/F3(t=120)
2. **投料时间关系**: fid=0 的 t=60 夹在 fid=1 的 t=40 和 t=80 之间，可作为参考
3. **理论最优**: titre ≈ 197.6 (T=32°C, pH=7.2, F1=30, F2=0, F3=44)
4. **最优 F2=0**: 理论最优在 t=80 时不投料，这对从 fid=0 的 F2 迁移是一个挑战
